generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  name      String
  email     String    @unique
  password  String
  role      UserRole  @default(USER)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Cliente {
  id          Int         @id @default(autoincrement())
  nomeCompleto String
  cpf         String      @unique
  email       String      @unique
  telefone    String
  tipo        ClienteTipo @default(VISITANTE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  comandas    Comanda[]
  reservas    Reserva[]
  lancamentos Lancamento[]
  mesas       Mesa[]      // Mesas onde o cliente está (opcional)
}

model Mesa {
  id          Int       @id @default(autoincrement())
  numero      Int       @unique
  ativa       Boolean   @default(true)
  clienteId   Int?      // Cliente atual na mesa (opcional - pode estar livre)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  cliente     Cliente?  @relation(fields: [clienteId], references: [id])
  comandas    Comanda[] // Uma mesa pode ter várias comandas
}

model Quadra {
  id          Int       @id @default(autoincrement())
  nome        String    @unique
  ativa       Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  reservas    Reserva[]
}

model Produto {
  id           Int             @id @default(autoincrement())
  name         String
  description  String?
  category     ProductCategory
  priceCents   Int
  active       Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  comandaItems ComandaItem[]
  lancamentoItems LancamentoItem[]
  estoque      Estoque?
}

model Estoque {
  id            Int      @id @default(autoincrement())
  produtoId     Int      @unique
  quantidade    Int      @default(0)
  minQuantidade Int      @default(0)
  updatedAt     DateTime @updatedAt
  produto       Produto  @relation(fields: [produtoId], references: [id])
}

model Reserva {
  id                   Int             @id @default(autoincrement())
  clienteId            Int
  quadraId             Int
  data                 DateTime
  hora                 Int
  precoCents           Int
  status               ReservaStatus   @default(ATIVA)
  observacoes          String?
  recorrente           Boolean         @default(false)
  diaSemana            Int?            // 0=domingo, 1=segunda, ..., 6=sábado
  dataFimRecorrencia   DateTime?       // Data limite para a recorrência
  reservaPaiId         Int?            // ID da reserva original que gerou esta recorrência
  payment              PaymentMethod?   // Método de pagamento
  valorPagoCents       Int            @default(0) // Valor já pago em centavos
  percentualPago       Int             @default(0) // 0, 50 ou 100
  statusPagamento      PagamentoStatus @default(PENDENTE)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  cliente              Cliente        @relation(fields: [clienteId], references: [id])
  quadra               Quadra         @relation(fields: [quadraId], references: [id])
  reservaPai           Reserva?       @relation("ReservaRecorrencia", fields: [reservaPaiId], references: [id])
  reservasFilhas       Reserva[]      @relation("ReservaRecorrencia")

  @@unique([data, hora, quadraId])
}


model Comanda {
  id           Int            @id @default(autoincrement())
  clienteId    Int?
  mesaId       Int?           // Relação com mesa (opcional)
  openedAt     DateTime       @default(now())
  closedAt     DateTime?
  totalCents   Int            @default(0)
  payment      PaymentMethod?
  notes        String?
  cliente      Cliente?       @relation(fields: [clienteId], references: [id])
  mesa         Mesa?          @relation(fields: [mesaId], references: [id])
  items        ComandaItem[]
}

model ComandaItem {
  id          Int      @id @default(autoincrement())
  comandaId   Int
  description String
  quantity    Int      @default(1)
  unitCents   Int
  createdAt   DateTime @default(now())
  produtoId   Int?
  comanda     Comanda  @relation(fields: [comandaId], references: [id])
  produto     Produto? @relation(fields: [produtoId], references: [id])
}

model Lancamento {
  id              Int            @id @default(autoincrement())
  clienteId       Int?
  nomeCliente     String?
  items           LancamentoItem[]
  totalCents      Int            @default(0)
  payment         PaymentMethod
  createdAt       DateTime       @default(now())
  cliente         Cliente?       @relation(fields: [clienteId], references: [id])
}

model LancamentoItem {
  id            Int         @id @default(autoincrement())
  lancamentoId  Int
  produtoId     Int?
  description   String
  quantity      Int         @default(1)
  unitCents     Int
  createdAt     DateTime    @default(now())
  lancamento    Lancamento  @relation(fields: [lancamentoId], references: [id])
  produto       Produto?    @relation(fields: [produtoId], references: [id])
}

enum UserRole {
  ADMIN
  USER
}

enum PaymentMethod {
  CASH
  PIX
  CARD
}

enum ProductCategory {
  BEBIDA
  COMIDA
  SNACK
  OUTROS
}

enum ClienteTipo {
  FIXO
  VISITANTE
}

enum ReservaStatus {
  ATIVA
  CANCELADA
  CONCLUIDA
}

enum PagamentoStatus {
  PENDENTE
  PARCIAL
  TOTAL
}
